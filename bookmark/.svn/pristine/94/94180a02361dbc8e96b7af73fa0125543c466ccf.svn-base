///<reference path="scripts/jquery/jquery.d.ts" />
///<reference path="scripts/bookmark_right_click_menu.ts" />
///<reference path="scripts/bookmark_container.ts" />
namespace BookMark {
    class Popup {
        private bookMarkNavManager: BookMarkManager;
        private bookMarkNavRightMenu: BookMarkRightClickMenu;
        private selectedNode: BookMarkNode;

        constructor() {
            this.bookMarkNavManager = new BookMarkManager();
            this.initNavMenu();
            this.fillCurrBookMarkInfo();
            this.initSaveAction();
            this.initManagerAction(); 
        }

        private initSaveAction() {
            let showErrorMessage = (msg:string)=>{
                $("#error_msg").html(msg).show();
            };
            let hideErrorMessage = ()=>{
                $("#error_msg").html('').hide();
            };
            $("#ok").bind("click",()=>{
                let title = $.trim( $("#title").val() );
                let url = $.trim( $("#url").val() );
                if( title == '' ) {
                    showErrorMessage("请输入标题");
                    return;
                }
                if( url == '' ) {
                    showErrorMessage("请输入网址");
                    return;
                }
                if( this.selectedNode == null ) {
                    showErrorMessage("请选择目录");
                    return;
                }
                let bookMarkId = this.selectedNode.getSource().id;

                hideErrorMessage();
            });
        }

        private initManagerAction() {

        }

        private fillCurrBookMarkInfo() {
            chrome.tabs.getSelected((tab: chrome.tabs.Tab )=>{
                $("#title").val(tab.title);
                $("#url").val(tab.url);
            });
        }

        private initNavMenu() {
            this.bookMarkNavManager = new BookMarkManager();

            this.bookMarkNavManager.addBookMarkData({ id: 0, pid: -1, title: "" });

            this.bookMarkNavManager.addBookMarkData({ id: 1, pid: 0, title: `目录1` });
            this.bookMarkNavManager.addBookMarkData({ id: 2, pid: 0, title: `目录2` });
            this.bookMarkNavManager.addBookMarkData({ id: 3, pid: 0, title: `目录3` });

            this.bookMarkNavManager.addBookMarkData({ id: 11, pid: 1, title: `目录11` });
            this.bookMarkNavManager.addBookMarkData({ id: 12, pid: 1, title: `目录12` });

            this.bookMarkNavManager.addBookMarkData({ id: 21, pid: 2, title: `目录21` });
            this.bookMarkNavManager.addBookMarkData({ id: 22, pid: 2, title: `目录22` });

            this.bookMarkNavManager.addBookMarkData({ id: 211, pid: 21, title: `目录211` });
            this.bookMarkNavManager.addBookMarkData({ id: 212, pid: 21, title: `目录212` });

            this.bookMarkNavManager.onNodeClick = (arg: BookMarkNode) => {
                this.selectedNode = arg;
                this.bookMarkNavManager.select(arg);
            };
            this.bookMarkNavManager.render("cate");
        }
    }

    new Popup();
}