///<reference path="common.ts" />

namespace BookMark {
    export class DataSource {
        private static KEY_CATE = "book_mark_cate";
        private static KEY_PAGE = "book_mark_page";


        private static async jsonpHttp(url: string, data = ""): Promise<any> {
            return new Promise<any>((resolve, reject) => {
                let ajaxSetting = {} as JQueryAjaxSettings;
                ajaxSetting.url = url;
                ajaxSetting.type = "post";
                ajaxSetting.dataType = "html";
                ajaxSetting.data = { data: data };
                ajaxSetting.success = (response) => {
                    resolve(response);
                }
                ajaxSetting.error = () => {
                    reject("请求出错");
                }
                $.ajax(ajaxSetting);
            });
        }
 
        private static getDataURL(method: string): string {
            let url = `http://localhost:9528/bookmark?method=${method}`;
            return url;
        }
    
        public static async getCategories(): Promise<BookMarkDataItem[]>{
            let url = DataSource.getDataURL("getCategories");
            let data = await DataSource.jsonpHttp(url);
            if (!data) {
                return [{ id: 0, pid: -1, title: "" }];
            } else {
                let result = JSON.parse(data);
                return (result as BookMarkDataItem[]);
            }
        }

        public static async updateCategories(data: BookMarkDataItem[]): Promise<void>{
            let dataString = JSON.stringify(data);
            let url = DataSource.getDataURL("updateCategories");
            await DataSource.jsonpHttp(url, dataString);
        }

        private static async getAllPages(): Promise<BookMarkPageDataItem[]> {
            let url = DataSource.getDataURL("getAllPages");
            let jsonString = await DataSource.jsonpHttp(url) || "[]";
            let jsonData = JSON.parse(jsonString);
            let data = jsonData as BookMarkPageDataItem[];
            return data;
        }

        private static async setAllPages(allData: BookMarkPageDataItem[]): Promise<void>{
            let dataString = JSON.stringify(allData);
            let url = DataSource.getDataURL("setAllPages");
            await DataSource.jsonpHttp(url, dataString);
        }

        public static async addPage(page: BookMarkPageDataItem): Promise<void> {
            let data = await DataSource.getAllPages();
            data.push(page);
            await DataSource.setAllPages(data);
        }

        public static async removePage(id: string): Promise<void> {
            let data = await DataSource.getAllPages();
            data = data.filter(n => n.id != id);
            await DataSource.setAllPages(data);
        }

        public static async editPage(page: BookMarkPageDataItem): Promise<void> {
            await this.removePage(page.id);
            await this.addPage(page);
        }

        public static async getPages(cid: number): Promise<BookMarkPageDataItem[]> {
            const data = await DataSource.getAllPages();
            return data.filter(n => n.cid == cid);
        }
    }
}